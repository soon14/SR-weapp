const app = getApp();
Page({
    /**
     * 页面的初始数据
     */
    data: {
        orderId: '',
        order_status: '',
        ji_name: '',
        ji_tel: '',
        ji_address: '',
        ji_lat: '',
        ji_lon: '',
        shou_name: '',
        shou_tel: '',
        shou_address: '',
        shou_lat: '',
        shou_lon: '',
        goodsname: '',
        remark: '',
        is_jia: '',
        jia_price: '',
        pay_price: '',
        gl: '',
        zl: '',

        noclose: false, //取消订单失败显示
        showSuccess: false, //取消订单成功显示

    },

    /**
     * 生命周期函数--监听页面加载
     */
    onLoad(options) {
        console.log(options.orderid);
        this.setData({
            orderid: options.orderid
        })

        this.getOrderDetail(options.orderid);
    },
    querenQJ() {
        var that = this;
        wx.request({
            url: getApp().globalData.baseURL + 'Order/getQRSH',
            data: {
                orderId: that.data.orderId,
            },
            method: 'post',
            header: {
                'content-type': 'application/json'
            },
            success(res) {
                console.log(res.data)
                console.log(res)
                that.getOrderDetail(that.data.orderId);
                if (res.data.code == 1) {
                    wx.showToast({
                        title: '操作成功！',
                    })
                } else {
                    wx.showToast({
                        title: res.data.msg,
                    })

                }

            },

            fail() {
                console.log('数据加载失败')
            }
        })
    },
    querenSH() {
        var that = this;
        wx.request({
            url: getApp().globalData.baseURL + 'Order/getQRSD',
            data: {
                orderId: that.data.orderId,
            },
            method: 'post',
            header: {
                'content-type': 'application/json'
            },
            success(res) {
                console.log(res.data)
                console.log(res)
                that.getOrderDetail(that.data.orderId);

                if (res.data.code == 1) {
                    wx.showToast({
                        title: '操作成功！',
                    })
                }
            },

            fail() {
                console.log('数据加载失败')
            }
        })
    },

    getOrderDetail(orderid) {
        var that = this;
        wx.request({
            url: getApp().globalData.baseURL + 'order/getOrderDetailById',

            data: {
                orderId: orderid,
            },
            method: 'post',
            header: {
                'content-type': 'application/json'
            },
            success(res) {
                console.log('getOrderDetailById')
                console.log(res.data)

                if (res.data.code == 1) {
                    console.log(res.data.data.orderid);
                    that.setData({
                        orderId: res.data.data.orderid,
                        order_status: res.data.data.order_status,
                        ji_name: res.data.data.ji_name,
                        ji_tel: res.data.data.ji_tel,
                        ji_address: res.data.data.ji_address,
                        ji_lat: res.data.data.ji_lat,
                        ji_lon: res.data.data.ji_lon,
                        shou_name: res.data.data.shou_name,
                        shou_tel: res.data.data.shou_tel,
                        shou_address: res.data.data.shou_address,
                        shou_lat: res.data.data.shou_lat,
                        shou_lon: res.data.data.shou_lon,
                        goodsname: res.data.data.goodsname,
                        get_phone: res.data.data.get_phone || '',
                        remark: res.data.data.remark,
                        isjia: res.data.data.isjia,
                        jia_price: res.data.data.jia_price,
                        pay_price: res.data.data.payprice,
                        gl: res.data.data.gl,
                        zl: res.data.data.zl,
                        getorder_status: res.data.data.getorder_status,
                        time: res.data.data.time,
                    })
                }
            },

            fail() {
                console.log('数据加载失败')
            }
        })
    },
    peisongPos() {
        wx.navigateTo({
            url: '/pages/peisongyuan/peisongyuan',
        })
    },
    closeO() {
        /**
         * 取消订单
         */
        let that = this;

        let orderid = that.data.orderid;
        that.getOrderDetail(orderid);

        let getorder_status = that.data.getorder_status;
        let order_status = that.data.order_status;

        let time = parseInt(that.data.time); //下单时间的时间戳
        let time1 = time + 180; //加三分钟
        let nowTimestamp = Math.round(new Date() / 1000); //当前时间时间戳
        console.log("下单时间的时间戳", time);
        console.log("三分钟", time1);
        console.log("弹出提示时候的时间戳", nowTimestamp);

        if (order_status == 3) {
            that.noclose();
            return;
        }

        if (getorder_status == 1 && nowTimestamp > time1) {

            wx.showModal({
                title: '提示',
                content: '您的订单已经由邻速达骑手接单，取消将扣除5元爽约金',
                cancelText: '暂不取消',
                cancelColor: '#5c5c5c',
                confirmText: '确定取消',
                confirmColor: '#f58515',
                success(res) {
                    if (res.confirm) {

                        that.closeOrder();

                    } else if (res.cancel) {
                        console.log('用户点击取消')
                    }
                }
            })

        } else {

            wx.showModal({
                title: '提示',
                content: '确定取消订单？',
                cancelText: '暂不取消',
                cancelColor: '#5c5c5c',
                confirmText: '确定取消',
                confirmColor: '#f58515',
                success(res) {
                    if (res.confirm) {

                        that.getOrderDetail(orderid);
                        getorder_status = that.data.getorder_status;
                        order_status = that.data.order_status;

                        let nowTimestamp1 = Math.round(new Date() / 1000); //当前时间时间戳
                        let time2 = parseInt(that.data.time) + 180; //加三分钟
                        console.log("下单时间的时间戳111", that.data.time);
                        console.log("三分钟111", time2);
                        console.log("弹出提示时候的时间戳111", nowTimestamp1);

                        if (getorder_status == 1 && nowTimestamp1 > time2) {

                            wx.showModal({
                                title: '提示',
                                content: '您的订单已经由邻速达骑手接单，取消将扣除5元爽约金',
                                cancelText: '暂不取消',
                                cancelColor: '#5c5c5c',
                                confirmText: '确定取消',
                                confirmColor: '#f58515',
                                success(res) {
                                    if (res.confirm) {

                                        that.closeOrder();

                                    } else if (res.cancel) {
                                        console.log('用户点击取消')
                                    }
                                }
                            })
                            return;
                        }

                        that.closeOrder();

                    } else if (res.cancel) {
                        console.log('用户点击取消')
                    }
                }
            })
        }




    },
    closeOrder() {
        /**
         * 取消订单
         */
        let that = this;
        let _openid = wx.getStorageSync('openid');
        let _orderId = that.data.orderId;

        let params = {
            openId: _openid,
            orderId: that.data.orderId
        };

        wx.request({
            url: app.globalData.baseURL + 'Order/cancel',
            data: params,
            method: 'post',
            success(res) {
                console.log('Order/cancel', res)
                if (res.data.code == 1) {

                    that.setData({
                        showSuccess: !that.data.showSuccess
                    })

                    that.getOrderDetail(_orderId);

                    setTimeout(function () {
                        that.setData({
                            showSuccess: !that.data.showSuccess
                        })
                    }, 1500)

                } else {
                    wx.showModal({
                        title: '提示',
                        showCancel: false,
                        content: res.data.msg,
                        success(res) {}
                    })
                }
            },
            fail(res) {
                console.log(res)
            }
        })
    },
    noclose() {
        this.setData({
            noclose: !this.data.noclose
        })
    },
    makePhoneCall(e) {
        let tel = e.currentTarget.dataset.telphone;
        wx.makePhoneCall({
            phoneNumber: tel
        })
    },
})